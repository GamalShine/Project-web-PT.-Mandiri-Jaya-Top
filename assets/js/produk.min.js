// Inisialisasi DataTable untuk produk
let produk = $("#produk").DataTable({
    responsive: true,
    scrollX: true,
    ajax: readUrl, // URL untuk membaca data
    columnDefs: [
        {
            searchable: false,
            orderable: false,
            targets: 0 // Kolom pertama tidak dapat diurutkan dan dicari
        }
    ],
    order: [[1, "asc"]], // Mengurutkan berdasarkan kolom kedua (barcode) secara ascending
    columns: [
        { data: null }, // Kolom untuk nomor urut
        { data: "barcode" }, // Kolom untuk barcode
        { data: "nama" }, // Kolom untuk nama produk
        { data: "satuan" }, // Kolom untuk satuan produk
        { data: "kategori" }, // Kolom untuk kategori produk
        { data: "harga" }, // Kolom untuk harga produk
        { data: "stok" }, // Kolom untuk stok produk
        { data: "action" } // Kolom untuk aksi (misalnya, tombol edit)
    ]
});

// Fungsi untuk me-reload tabel
function reloadTable() {
    produk.ajax.reload();
}

// Fungsi untuk menambahkan data produk baru
function addData() {
    $.ajax({
        url: addUrl, // URL untuk menambahkan data
        type: "post",
        dataType: "json",
        data: $("#form").serialize(),
        success: () => {
            $(".modal").modal("hide");
            Swal.fire("Sukses", "Sukses Menambahkan Data", "success");
            reloadTable();
        },
        error: error => {
            console.log(error);
        }
    });
}

// Fungsi untuk menghapus data produk
function remove(id) {
    Swal.fire({
        title: "Hapus",
        text: "Hapus data ini?",
        type: "warning",
        showCancelButton: true
    }).then(result => {
        if (result.value) {
            $.ajax({
                url: deleteUrl, // URL untuk menghapus data
                type: "post",
                dataType: "json",
                data: { id: id },
                success: () => {
                    Swal.fire("Sukses", "Sukses Menghapus Data", "success");
                    reloadTable();
                },
                error: error => {
                    console.log(error);
                }
            });
        }
    });
}

// Fungsi untuk mengedit data produk
function editData() {
    $.ajax({
        url: editUrl, // URL untuk mengedit data
        type: "post",
        dataType: "json",
        data: $("#form").serialize(),
        success: () => {
            $(".modal").modal("hide");
            Swal.fire("Sukses", "Sukses Mengedit Data", "success");
            reloadTable();
        },
        error: error => {
            console.log(error);
        }
    });
}

// Fungsi untuk menampilkan form tambah data produk
function add() {
    url = "add";
    $(".modal-title").html("Add Data");
    $('.modal button[type="submit"]').html("Add");
}

// Fungsi untuk menampilkan form edit data produk
function edit(id) {
    $.ajax({
        url: getProdukUrl, // URL untuk mendapatkan data produk berdasarkan ID
        type: "post",
        dataType: "json",
        data: { id: id },
        success: data => {
            $('[name="id"]').val(data.id);
            $('[name="barcode"]').val(data.barcode);
            $('[name="nama_produk"]').val(data.nama_produk);
            $('[name="satuan"]').append(`<option value='${data.satuan_id}'>${data.satuan}</option>`);
            $('[name="kategori"]').append(`<option value='${data.kategori_id}'>${data.kategori}</option>`);
            $('[name="harga"]').val(data.harga);
            $('[name="stok"]').val(data.stok);
            $(".modal").modal("show");
            $(".modal-title").html("Edit Data");
            $('.modal button[type="submit"]').html("Edit");
            url = "edit";
        },
        error: error => {
            console.log(error);
        }
    });
}

// Mengatur nomor urut tabel setelah order atau search
produk.on("order.dt search.dt", () => {
    produk.column(0, { search: "applied", order: "applied" }).nodes().each((cell, i) => {
        cell.innerHTML = i + 1;
    });
});

// Validasi form menggunakan jQuery Validation Plugin
$("#form").validate({
    errorElement: "span",
    errorPlacement: (error, element) => {
        error.addClass("invalid-feedback");
        element.closest(".form-group").append(error);
    },
    submitHandler: () => {
        // Jika url adalah 'edit', panggil fungsi editData(), jika tidak, panggil addData()
        (url === "edit") ? editData() : addData();
    }
});

// Mengatur Select2 untuk kategori dan satuan
$("#kategori").select2({
    placeholder: "Kategori",
    ajax: {
        url: kategoriSearchUrl,
        type: "post",
        dataType: "json",
        data: term => ({ kategori: term }),
        processResults: data => ({ results: data }),
        cache: true
    }
});

$("#satuan").select2({
    placeholder: "Satuan",
    ajax: {
        url: satuanSearchUrl,
        type: "post",
        dataType: "json",
        data: term => ({ satuan: term }),
        processResults: data => ({ results: data }),
        cache: true
    }
});

// Reset form dan validasi saat modal ditutup
$(".modal").on("hidden.bs.modal", () => {
    $("#form")[0].reset();
    $("#form").validate().resetForm();
});
