// Inisialisasi DataTable untuk stok masuk
let stok_masuk = $("#stok_masuk").DataTable({
    responsive: true,
    scrollX: true,
    ajax: readUrl, // URL untuk membaca data
    columnDefs: [
        {
            searchable: false,
            orderable: false,
            targets: 0 // Kolom pertama tidak dapat diurutkan dan dicari
        }
    ],
    order: [[1, "asc"]], // Mengurutkan berdasarkan kolom kedua (tanggal) secara ascending
    columns: [
        { data: null }, // Kolom untuk nomor urut
        { data: "tanggal" }, // Kolom untuk tanggal
        { data: "barcode" }, // Kolom untuk barcode
        { data: "nama_produk" }, // Kolom untuk nama produk
        { data: "jumlah" }, // Kolom untuk jumlah
        { data: "keterangan" } // Kolom untuk keterangan
    ]
});

// Fungsi untuk me-reload tabel
function reloadTable() {
    stok_masuk.ajax.reload();
}

// Fungsi untuk mengecek keterangan dan mengubah tampilan form sesuai dengan kondisi
function checkKeterangan(element) {
    if (element.value === "lain") {
        $(".supplier").hide(); // Sembunyikan elemen dengan class 'supplier'
        $("#supplier").attr("disabled", "disabled"); // Matikan input supplier
        $(".lain").removeClass("d-none"); // Hapus class 'd-none' dari elemen dengan class 'lain'
    } else {
        $(".lain").addClass("d-none"); // Tambahkan class 'd-none' dari elemen dengan class 'lain'
        $("#supplier").removeAttr("disabled"); // Aktifkan kembali input supplier
        $(".supplier").show(); // Tampilkan elemen dengan class 'supplier'
    }
}

// Fungsi untuk menambahkan data stok masuk
function addData() {
    $.ajax({
        url: addUrl, // URL untuk menambahkan data
        type: "post",
        dataType: "json",
        data: $("#form").serialize(),
        success: () => {
            $(".modal").modal("hide");
            Swal.fire("Sukses", "Sukses Menambahkan Data", "success");
            reloadTable();
        },
        error: error => {
            console.log(error);
        }
    });
}

// Mengatur nomor urut tabel setelah order atau search
stok_masuk.on("order.dt search.dt", () => {
    stok_masuk.column(0, { search: "applied", order: "applied" }).nodes().each((cell, i) => {
        cell.innerHTML = i + 1;
    });
});

// Validasi form menggunakan jQuery Validation Plugin
$("#form").validate({
    errorElement: "span",
    errorPlacement: (error, element) => {
        error.addClass("invalid-feedback");
        element.closest(".form-group").append(error);
    },
    submitHandler: () => {
        addData();
    }
});

// Mengatur DateTimePicker untuk input tanggal
$("#tanggal").datetimepicker({
    format: "dd-mm-yyyy h:ii:ss"
});

// Mengatur Select2 untuk input barcode
$("#barcode").select2({
    placeholder: "Barcode",
    ajax: {
        url: getBarcodeUrl,
        type: "post",
        dataType: "json",
        data: term => ({ barcode: term }),
        processResults: data => ({ results: data }),
        cache: true
    }
});

// Mengatur Select2 untuk input supplier
$("#supplier").select2({
    placeholder: "Supplier",
    ajax: {
        url: supplierSearchUrl,
        type: "post",
        dataType: "json",
        data: term => ({ supplier: term }),
        processResults: data => ({ results: data }),
        cache: true
    }
});

// Reset form dan validasi saat modal ditutup
$(".modal").on("hidden.bs.modal", () => {
    $("#form")[0].reset();
    $("#form").validate().resetForm();
});

// Set tanggal default saat modal ditampilkan
$(".modal").on("show.bs.modal", () => {
    let currentDate = moment().format("D-MM-Y H:mm:ss");
    $("#tanggal").val(currentDate);
});
